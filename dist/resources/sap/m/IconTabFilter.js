/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./library","sap/ui/core/library","sap/ui/core/Core","sap/ui/core/Item","sap/ui/core/Renderer","sap/ui/core/IconPool","sap/ui/core/InvisibleText","sap/ui/core/Control","sap/ui/Device","./AccButton","sap/m/BadgeCustomData","sap/m/Button","sap/m/ResponsivePopover","sap/m/IconTabBarSelectList","sap/m/BadgeEnabler"],function(e,t,i,s,o,a,n,r,l,p,g,c,d,h,u){"use strict";var f=t.TextAlign;var _=t.TextDirection;var I=e.ButtonType;var v=e.PlacementType;var T=e.ImageHelper;var m=e.IconTabFilterDesign;var b=e.BadgeStyle;var B=t.IconColor;var y=3e3;var C=s.extend("sap.m.IconTabFilter",{metadata:{interfaces:["sap.m.IconTab","sap.ui.core.PopupInterface","sap.m.IBadge"],library:"sap.m",designtime:"sap/m/designtime/IconTabFilter.designtime",properties:{count:{type:"string",group:"Data",defaultValue:""},showAll:{type:"boolean",group:"Misc",defaultValue:false},icon:{type:"sap.ui.core.URI",group:"Misc",defaultValue:""},iconColor:{type:"sap.ui.core.IconColor",group:"Appearance",defaultValue:B.Default},iconDensityAware:{type:"boolean",group:"Appearance",defaultValue:true},visible:{type:"boolean",group:"Behavior",defaultValue:true},design:{type:"sap.m.IconTabFilterDesign",group:"Appearance",defaultValue:m.Vertical}},defaultAggregation:"content",aggregations:{content:{type:"sap.ui.core.Control",multiple:true,singularName:"content"},items:{type:"sap.m.IconTab",multiple:true,singularName:"item"},_expandButton:{type:"sap.m.Button",multiple:false,visibility:"hidden"}}}});u.call(C.prototype);var x=i.getLibraryResourceBundle("sap.m");C._aAllIconColors=["sapMITBFilterCritical","sapMITBFilterPositive","sapMITBFilterNegative","sapMITBFilterDefault","sapMITBFilterNeutral"];C.prototype._getImageControl=function(e,t,i){var s={src:this.getIcon(),densityAware:this.getIconDensityAware(),useIconTooltip:false};if(s.src){this._oImageControl=T.getImageControl(this.getId()+"-icon",this._oImageControl,t,s,e,i)}else if(this._oImageControl){this._oImageControl.destroy();this._oImageControl=null}return this._oImageControl};C.prototype.init=function(){this._oDragEventDelegate={onlongdragover:this._handleOnLongDragOver,ondragover:this._handleOnDragOver,ondragleave:this._handleOnDragLeave,ondrop:this._handleOnDrop};this.initBadgeEnablement({style:b.Attention,selector:{selector:".sapMITBBadgeHolder"}});this._oCloneInList=null};C.prototype.exit=function(e){if(this._oImageControl){this._oImageControl.destroy()}if(s.prototype.exit){s.prototype.exit.call(this,e)}if(this._invisibleText){this._invisibleText.destroy();this._invisibleText=null}if(this._oPopover){this._oPopover.destroy();this._oPopover=null}if(this._oExpandButton){this._oExpandButton.removeEventDelegate(this._oDragEventDelegate);this._oExpandButton.destroy();this._oExpandButton=null}this.removeEventDelegate(this._oDragEventDelegate);this._oDragEventDelegate=null;if(this._iHideBadgeTimeout){clearTimeout(this._iHideBadgeTimeout)}};C.prototype.invalidate=function(){var e=this.getParent(),t,i;if(!e){return}t=e.getParent();if(!(t instanceof sap.m.IconTabBar)){e.invalidate();return}i=t.getParent();if(i instanceof sap.m.ObjectHeader){i.invalidate()}else{t.invalidate()}};C.prototype.setProperty=function(e,t,i){switch(e){case"enabled":case"textDirection":case"text":case"count":case"showAll":case"icon":case"iconColor":case"iconDensityAware":case"design":if(this.getProperty(e)===t){return this}r.prototype.setProperty.call(this,e,t,true);if(!i){var s=this.getParent();if(s instanceof sap.m.IconTabHeader){s.invalidate()}}break;default:r.prototype.setProperty.apply(this,arguments);break}return this};C.prototype._getNonEmptyKey=function(){var e=this.getKey();if(e){return e}return this.getId()};C.prototype._getRealTab=function(){return this._oRealItem||this};C.prototype._getRootTab=function(){var e=this._getRealTab(),t=e.getParent();while(t&&t.isA("sap.m.IconTabFilter")){e=t;t=t.getParent()}return e};C.prototype._getNestedLevel=function(){var e=this._getRealTab().getParent(),t;for(t=1;e&&e.isA("sap.m.IconTabFilter");t++){e=e.getParent()}return t};C.prototype.render=function(e,t,i){if(!this.getVisible()){return}this._prepareDragEventDelegate();var s=this.getParent(),o=s.getParent(),n=s._isInsideIconTabBar(),r={role:"tab"},l=this.getId(),p=this.getCount(),g=this.getText(),c=this.getIcon(),d=this.getIconColor(),h=d==="Positive"||d==="Critical"||d==="Negative"||d==="Neutral",u=this.getDesign()===m.Horizontal,f=s._bTextOnly,_=s._bInLine||s.isInlineMode(),I=this.getShowAll();if(n){r.controls=o.getId()+"-content"}if(this.getItems().length){r.roledescription=x.getText("ICONTABFILTER_SPLIT_TAB")}if(g.length||p!==""||c){var v=[];if(p!==""){v.push(l+"-count")}if(g.length){v.push(l+"-text")}if(c){v.push(l+"-icon")}if(h){v.push(l+"-iconColor")}r.labelledby=v.join(" ")}if(t!==undefined&&i!==undefined){Object.assign(r,{posinset:t+1,setsize:i})}e.openStart("div",this).accessibilityState(r).class("sapMITBItem");if(!p){e.class("sapMITBItemNoCount")}if(u){e.class("sapMITBHorizontal")}else{e.class("sapMITBVertical")}if(I){e.class("sapMITBAll")}else{e.class("sapMITBFilter").class("sapMITBFilter"+d)}if(s._isUnselectable(this)){e.class("sapMITHUnselectable")}if(this.getItems().length>0){e.class("sapMITBFilterWithItems")}if(!this.getEnabled()){e.class("sapMITBDisabled").attr("aria-disabled",true)}e.attr("aria-selected",false);var T=this.getTooltip_AsString();if(T){e.attr("title",T)}if(this._bIsOverflow||this.getItems().length){e.attr("aria-haspopup","menu")}e.openEnd();e.openStart("div").class("sapMITBFilterWrapper").openEnd();if(!_){e.openStart("div",l+"-tab").class("sapMITBTab").openEnd();if(!I||!c){if(h){e.openStart("div",l+"-iconColor").style("display","none").openEnd().text(x.getText("ICONTABBAR_ICONCOLOR_"+d.toUpperCase())).close("div")}e.renderControl(this._getImageControl(["sapMITBFilterIcon","sapMITBBadgeHolder","sapMITBFilter"+d],s,C._aAllIconColors))}if(!I&&!c&&!f){e.openStart("span").class("sapMITBFilterNoIcon").openEnd().close("span")}if(u&&!I){e.close("div");e.openStart("div").class("sapMITBHorizontalWrapper").openEnd()}e.openStart("span",l+"-count").class("sapMITBCount");if(I||!c&&!g.length){e.class("sapMITBBadgeHolder")}e.openEnd();if(p===""&&u){e.unsafeHtml("&nbsp;")}else{e.text(p)}e.close("span");if(!u){e.close("div")}}if(g.length){e.openStart("div",l+"-text").class("sapMITBText");if(n&&o.getUpperCase()){e.class("sapMITBTextUpperCase")}if(_){e.attr("dir","ltr")}e.openEnd();e.openStart("span").class("sapMITHTextContent");if(!c&&!I){e.class("sapMITBBadgeHolder")}e.openEnd();e.text(s._getDisplayText(this));e.close("span");if(this._bIsOverflow||this.getItems().length&&s._isUnselectable(this)){e.openStart("span",this.getId()+"-expandButton").class("sapMITHShowSubItemsIcon").openEnd();e.icon(a.getIconURI("slim-arrow-down"),null,{title:null,"aria-hidden":true});e.close("span")}e.close("div")}if(!_&&u){e.close("div")}e.openStart("div").class("sapMITBContentArrow").openEnd().close("div");e.close("div");if(this.getItems().length&&!s._isUnselectable(this)){e.openStart("span").accessibilityState({role:"separator"}).openEnd().close("span");e.renderControl(this._getExpandButton())}if(this.getItems().length){this._updateExpandButtonBadge()}e.close("div")};C.prototype.renderInSelectList=function(e,t,i,s,o){if(this._invisibleText){this._invisibleText.destroy();this._invisibleText=null}if(!this.getVisible()){return}var a=true,r=t._bIconOnly,l=t._oIconTabHeader;if(l){a=l._bTextOnly}e.openStart("li",this).class("sapMITBSelectItem").attr("tabindex","-1").attr("role","menuitem");if(o){e.style("padding-left",o+"rem")}if(i!==undefined&&s!==undefined){e.attr("aria-posinset",i+1);e.attr("aria-setsize",s);e.attr("aria-level",this._getNestedLevel())}var p=this.getTooltip_AsString();if(p){e.attr("title",p)}if(l._isUnselectable(this)){e.class("sapMITHUnselectable")}if(!this.getEnabled()){e.class("sapMITBDisabled").attr("aria-disabled",true)}if(t.getSelectedItem()==this){e.class("sapMITBSelectItemSelected");e.attr("aria-selected",true)}var g=this.getIconColor();e.class("sapMITBFilter"+g);var c=this.getId(),d=g=="Positive"||g=="Critical"||g=="Negative"||g=="Neutral",h=[];if(!r){h.push(c+"-text")}if(!a&&this.getIcon()){h.push(c+"-icon")}if(d){this._invisibleText=new n({text:x.getText("ICONTABBAR_ICONCOLOR_"+g.toUpperCase())});h.push(this._invisibleText.getId())}e.accessibilityState({labelledby:h.join(" ")}).openEnd();if(this._invisibleText){e.renderControl(this._invisibleText)}if(!a){this._renderIcon(e,r)}if(!r){this._renderText(e)}e.close("li")};C.prototype._onAfterParentRendering=function(){this._renderBadge()};C.prototype._renderIcon=function(e,t){var i=this.getIcon();if(i){var s=a.getIconInfo(i),o=["sapMITBSelectItemIcon"];if(s&&!s.suppressMirroring){o.push("sapUiIconMirrorInRTL")}if(t){o.push("sapMITBBadgeHolder")}e.icon(i,o,{id:this.getId()+"-icon","aria-hidden":true})}else{e.openStart("span").class("sapUiIcon").openEnd().close("span")}};C.prototype._renderText=function(e){var t=this.getText(),s=this.getCount(),a=i.getConfiguration().getRTL(),n=this.getTextDirection();e.openStart("span",this.getId()+"-text").attr("dir","ltr").class("sapMText").class("sapMTextNoWrap").class("sapMITBText").class("sapMITBBadgeHolder");if(n!==_.Inherit){e.attr("dir",n.toLowerCase())}var r=o.getTextAlign(f.Begin,n);if(r){e.style("text-align",r)}if(s){if(a){t="("+s+") "+t}else{t+=" ("+s+")"}}e.openEnd().text(t).close("span")};C.prototype._getSelectList=function(){if(!this._oSelectList){this._oSelectList=new h({selectionChange:function(e){var t=e.getParameter("selectedItem");this._oIconTabHeader.setSelectedItem(t._getRealTab());this._oTabFilter._closePopover()}});this._oSelectList._oIconTabHeader=this.getParent();this._oSelectList._oTabFilter=this;this._oSelectList._bIsOverflow=this._bIsOverflow}return this._oSelectList};C.prototype._prepareDragEventDelegate=function(){if(this.getEnabled()){this.addEventDelegate(this._oDragEventDelegate,this)}else{this.removeEventDelegate(this._oDragEventDelegate)}};C.prototype._getExpandButton=function(){this._oExpandButton=this.getAggregation("_expandButton");if(!this._oExpandButton){this._oExpandButton=new p(this.getId()+"-expandButton",{type:I.Transparent,icon:a.getIconURI("slim-arrow-down"),tooltip:x.getText("ICONTABHEADER_OVERFLOW_MORE"),tabIndex:"-1",press:this._expandButtonPress.bind(this)}).addStyleClass("sapMITBFilterExpandBtn");this.setAggregation("_expandButton",this._oExpandButton)}return this._oExpandButton};C.prototype._updateExpandButtonBadge=function(){var e=this.getBadgeCustomData()&&this.getBadgeCustomData().getVisible(),t=this._hasChildWithBadge();if(t&&!e){this.addCustomData(new g({visible:true}))}else if(!t&&e){this.getBadgeCustomData().setVisible(false)}};C.prototype._hasChildWithBadge=function(){var e=this._bIsOverflow?this._getIconTabHeader()._getItemsForOverflow():this._getAllSubItems();return e.some(function(e){return e.isA("sap.m.IBadge")&&e.getBadgeCustomData()&&e.getBadgeCustomData().getVisible()})};C.prototype._expandButtonPress=function(){if(!this.getEnabled()){return}this.$().trigger("focus");if(!this._oPopover){this._oPopover=new d({showArrow:false,showHeader:false,offsetY:0,offsetX:0,placement:v.VerticalPreferredBottom}).addStyleClass("sapMITBFilterPopover");this._oPopover.attachBeforeClose(function(){this._getSelectList().destroyItems()},this);if(l.system.phone){this._oPopover._oControl.addButton(this._createPopoverCloseButton())}this.addDependent(this._oPopover);this._oPopover._oControl._adaptPositionParams=function(){var e=this.$().parents().hasClass("sapUiSizeCompact");this._arrowOffset=0;if(e){this._offsets=["0 0","0 0","0 4","0 0"]}else{this._offsets=["0 0","0 0","0 5","0 0"]}this._atPositions=["end top","end top","end bottom","begin top"];this._myPositions=["end bottom","begin top","end top","end top"]}}var e=this._setSelectListItems();var t=this._getSelectList();this._oPopover.removeAllContent();if(this.getItems().length||this._bIsOverflow){this._oPopover.addContent(t);this._oPopover.setInitialFocus(e?t.getSelectedItem():t.getVisibleTabFilters()[0]);this._oPopover.openBy(this)}};C.prototype._getAllSubItems=function(){var e=[];this._getRealTab().getItems().forEach(function(t){if(t.isA("sap.m.IconTabFilter")){e=e.concat(t,t._getAllSubItems())}else{e=e.concat(t)}});return e};C.prototype._getAllSubFilters=function(){return this._getAllSubItems().filter(function(e){return e.isA("sap.m.IconTabFilter")})};C.prototype._getAllSubFiltersDomRefs=function(){return this._getAllSubFilters().filter(function(e){return Boolean(e._getRealTab().getDomRef())}).map(function(e){return e._getRealTab().getDomRef()})};C.prototype._getFirstAvailableSubFilter=function(){var e=this._getAllSubFilters();for(var t=0;t<e.length;t++){var i=e[t];if(i.getContent().length&&i.getVisible()){return i}}return this};C.prototype._isParentOf=function(e){var t=this._getAllSubFilters();for(var i=0;i<t.length;i++){if(t[i]._getRealTab()===e){return true}}return false};C.prototype._createPopoverCloseButton=function(){return new c({text:x.getText("SELECT_CANCEL_BUTTON"),press:this._closePopover.bind(this)})};C.prototype._closePopover=function(){if(this._oPopover){this._oPopover.close();this._oPopover.removeAllContent()}if(this._bIsOverflow&&this.getParent().oSelectedItem){(this.getParent()._oSelectedRootItem||this.getParent().oSelectedItem).$().focus()}};C.prototype._handleOnDragOver=function(e){if(!this._bIsOverflow&&!this._getIconTabHeader().getMaxNestingLevel()){return}this.getDomRef().classList.add("sapMITHDragOver");e.preventDefault()};C.prototype._handleOnLongDragOver=function(){if(!this._bIsOverflow&&!this._getIconTabHeader().getMaxNestingLevel()){return}if(this._oPopover&&this._oPopover.isOpen()){return}this._expandButtonPress()};C.prototype._handleOnDrop=function(){this.getDomRef().classList.remove("sapMITHDragOver")};C.prototype._handleOnDragLeave=function(){this.getDomRef().classList.remove("sapMITHDragOver")};C.prototype._setSelectListItems=function(){var e=this.getParent(),t=this._getSelectList(),i=this._getAllSubItems(),s=e.oSelectedItem,o=false,a;if(this._bIsOverflow){i=e._getItemsForOverflow()}t.destroyItems();t.setSelectedItem(null);for(var n=0;n<i.length;n++){a=i[n];var r=a.clone(undefined,undefined,{cloneChildren:false,cloneBindings:true});if(a instanceof C&&a.getBadgeCustomData()){r.addCustomData(a.getBadgeCustomData().clone());a._oCloneInList=r}r._oRealItem=a;t.addItem(r);if(a.isA("sap.m.IconTabSeparator")){continue}if(r._getRealTab()===s){t.setSelectedItem(r);o=true;continue}if(r._getRealTab()._isParentOf(s)){t.setSelectedItem(s._getRealTab());o=true}}return o};C.prototype._getIconTabHeader=function(){return this._getRootTab().getParent()};C.prototype.onsapdown=function(e){if(!this.getEnabled()){return}if(this._bIsOverflow||this._getNestedLevel()===1&&this._getRealTab()===this&&this._getRealTab().getItems().length!==0){e.stopImmediatePropagation();this._expandButtonPress()}};C.prototype._startBadgeHiding=function(){if(this._iHideBadgeTimeout){return}this._iHideBadgeTimeout=setTimeout(this._hideBadge.bind(this),y)};C.prototype._hideBadge=function(){var e=this.getBadgeCustomData();if(!e){return}e.setVisible(false);this._getRootTab()._updateExpandButtonBadge();if(this._oCloneInList&&!this._oCloneInList.bIsDestroyed&&this._oCloneInList.getBadgeCustomData()){this._oCloneInList.getBadgeCustomData().setVisible(false);this._oCloneInList=null}if(this._isInOverflow()){this._getIconTabHeader()._getOverflow()._updateExpandButtonBadge()}this._iHideBadgeTimeout=null};C.prototype._isInOverflow=function(){var e=this.getDomRef();return e&&e.classList.contains("sapMITBFilterHidden")};return C});