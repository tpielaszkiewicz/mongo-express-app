/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/DataType","sap/ui/base/ManagedObject","sap/ui/core/CustomData","./mvc/View","./mvc/EventHandlerResolver","./ExtensionPoint","./StashedControlSupport","sap/ui/base/SyncPromise","sap/base/Log","sap/base/util/ObjectPath","sap/base/util/values","sap/base/assert","sap/base/security/encodeXML","sap/base/util/LoaderExtensions","sap/base/util/JSTokenizer","sap/base/util/isEmptyObject"],function(e,n,t,r,i,a,o,s,u,l,f,c,p,d,g,m,v){"use strict";function h(e,r,i,a,o){var s=t.bindingParser(r,a,true,false,false,false,o);if(s&&typeof s==="object"){return s}var u=r=s||r;var f=n.getType(e);if(f){if(f instanceof n){u=f.parseValue(r,{context:a,locals:o});if(!f.isValid(u)){l.error("Value '"+r+"' is not valid for type '"+f.getName()+"'.")}}}else{throw new Error("Property "+i+" has unknown type "+e)}return typeof u==="string"?t.bindingParser.escape(u):u}function w(e){return e.localName||e.baseName||e.nodeName}var y="http://www.w3.org/1999/xhtml";var b="http://www.w3.org/2000/svg";var _="sap.ui.core";var C="http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1";var x="http://schemas.sap.com/sapui5/extension/sap.ui.core.support.Support.info/1";var I="http://schemas.sap.com/sapui5/extension/sap.ui.core.xmlcomposite/1";var N="http://schemas.sap.com/sapui5/extension/sap.ui.core.Internal/1";var P="http://schemas.sap.com/sapui5/preprocessorextension/";function M(e,n){function t(e,t,r,i){var a,o,s=[];for(a=e.firstChild;a;a=a.nextSibling){o=n(e,t,r,a,false,i);if(o){s.push(o.unwrap())}}return u.resolve(s)}function r(e,t,r,i){var a,o=Promise.resolve(),s=[i];for(a=e.firstChild;a;a=a.nextSibling){o=o.then(n.bind(null,e,t,r,a,false,i));s.push(o)}return Promise.all(s)}return e?r:t}var V={};V.loadTemplate=function(e,n){var t=e.replace(/\./g,"/")+("."+(n||"view")+".xml");return g.loadResource(t).documentElement};V.loadTemplatePromise=function(e,n){var t=e.replace(/\./g,"/")+("."+(n||"view")+".xml");return g.loadResource(t,{async:true}).then(function(e){return e.documentElement})};V.parseViewAttributes=function(e,n,t){var r=n.getMetadata().getAllProperties();for(var i=0;i<e.attributes.length;i++){var a=e.attributes[i];if(a.name==="controllerName"){n._controllerName=a.value}else if(a.name==="resourceBundleName"){n._resourceBundleName=a.value}else if(a.name==="resourceBundleUrl"){n._resourceBundleUrl=a.value}else if(a.name==="resourceBundleLocale"){n._resourceBundleLocale=a.value}else if(a.name==="resourceBundleAlias"){n._resourceBundleAlias=a.value}else if(a.name==="class"){n.addStyleClass(a.value)}else if(!t[a.name]&&r[a.name]){t[a.name]=h(r[a.name].type,a.value,a.name,n._oContainingView.oController)}}};V.enrichTemplateIds=function(e,n){V.enrichTemplateIdsPromise(e,n,false);return e};V.enrichTemplateIdsPromise=function(e,n,t){return E(e,n,true,t).then(function(){return e})};V.parseTemplate=function(e,n){return V.parseTemplatePromise(e,n,false).unwrap()};V.parseTemplatePromise=function(e,n,t,r){return E(e,n,false,t,r).then(function(){var e=u.resolve();var r=arguments;if(n.isA("sap.ui.core.mvc.View")&&n._epInfo&&n._epInfo.all.length>0){e=S(t,n,{content:n._epInfo.all})}return e.then(function(){if(Array.isArray(r[0])){r[0]=r[0].filter(function(e){return!e._isExtensionPoint})}return r[0]})})};function A(e){var n,t=/^[a-zA-Z_$][a-zA-Z0-9_$]*$/;if(!e||typeof e!=="object"){n="core:require in XMLView can't be parsed to a valid object"}else{Object.keys(e).some(function(r){if(!t.test(r)){n="core:require in XMLView contains invalid identifier: '"+r+"'";return true}if(!e[r]||typeof e[r]!=="string"){n="core:require in XMLView contains invalide value '"+e[r]+"'under key '"+r+"'";return true}})}return n}function R(e,n){var t=e.getAttributeNS(_,"require"),r,i,a;if(t){try{r=m.parseJS(t)}catch(n){l.error("Require attribute can't be parsed on Node: ",e.nodeName);throw n}a=A(r);if(a){throw new Error(a+" on Node: "+e.nodeName)}if(!v(r)){i={};if(n){return new Promise(function(e,n){var t=Object.keys(r).reduce(function(e,n){i[n]=sap.ui.require(r[n]);return e&&i[n]!==undefined},true);if(t){e(i);return}sap.ui.require(c(r),function(){var n=arguments;Object.keys(r).forEach(function(e,t){i[e]=n[t]});e(i)},n)})}else{Object.keys(r).forEach(function(e){i[e]=sap.ui.requireSync(r[e])});return u.resolve(i)}}}}function S(e,n,t){var r=u.resolve();if(!v(t)){var i=[];var a;if(e){r=new Promise(function(e){a=e})}Object.keys(t).forEach(function(e){var r=t[e];r.forEach(function(e){e.targetControl=n;var t=sap.ui.require(e.providerClass);if(t){i.push(t.applyExtensionPoint(e))}else{var r=new Promise(function(n,t){sap.ui.require([e.providerClass],function(e){n(e)},t)}).then(function(n){return n.applyExtensionPoint(e)});i.push(r)}})});if(e){Promise.all(i).then(a)}}return r}function E(n,c,g,m,A){var E=[],T=R(n,m)||u.resolve();m=m&&c._sProcessingMode==="sequential";l.debug("XML processing mode is "+(m?"sequential":"default"),"","XMLTemplateProcessor");var q=sap.ui.getCore().getConfiguration().getDesignMode();if(q){c._sapui_declarativeSourceInfo={xmlNode:n,xmlRootNode:c._oContainingView===c?n:c._oContainingView._sapui_declarativeSourceInfo.xmlRootNode}}var L=c.sViewName||c._sFragmentName;if(!L){var O=c;var j=0;while(++j<1e3&&O&&O!==O._oContainingView){O=O._oContainingView}L=O.sViewName}if(c.isSubView()){D(n,true,false,T)}else{if(n.localName==="View"&&n.namespaceURI!=="sap.ui.core.mvc"){l.warning("XMLView root node must have the 'sap.ui.core.mvc' namespace, not '"+n.namespaceURI+"'"+(L?" (View name: "+L+")":""))}F(n,false,false,T)}var U=0;function X(){for(;U<E.length;U++){var e=E[U];if(e&&typeof e.then==="function"){return e.then(k).then(X)}}return E}function k(e){var n=[U,1].concat(e);Array.prototype.splice.apply(E,n)}return T.then(X);function B(e){return e}function W(e){return c._oContainingView.createId(e)}function D(e,n,t,r){if(e.nodeType===1){var i=w(e);if(e.namespaceURI===y||e.namespaceURI===b){E.push("<"+i+" ");var a=false;for(var o=0;o<e.attributes.length;o++){var s=e.attributes[o];var u=s.value;if(s.name==="id"){a=true;u=$(c,e)}E.push(s.name+'="'+d(u)+'" ')}if(n===true){E.push("data-sap-ui-preserve"+'="'+c.getId()+'" ');if(!a){E.push("id"+'="'+c.getId()+'" ')}}E.push(">");var l=e;if(window.HTMLTemplateElement&&e instanceof HTMLTemplateElement&&e.content instanceof DocumentFragment){l=e.content}F(l,false,false,r);E.push("</"+i+">")}else if(i==="FragmentDefinition"&&e.namespaceURI===_){F(e,false,true,r)}else{T=T.then(function(){return z(e,r).then(function(e){for(var n=0;n<e.length;n++){var t=e[n];if(c.getMetadata().hasAggregation("content")){c._epInfo=c._epInfo||{contentControlsCount:0,last:null,all:[]};if(t._isExtensionPoint){t.index=c._epInfo.contentControlsCount;t.targetControl=c;t.aggregationName="content";if(c._epInfo.last){c._epInfo.last._nextSibling=t}c._epInfo.last=t;c._epInfo.all.push(t)}else{c._epInfo.contentControlsCount++;c.addAggregation("content",t)}}else if(c.getMetadata().hasAssociation("content")){c.addAssociation("content",t)}}return e})});E.push(T)}}else if(e.nodeType===3&&!t){var f=e.textContent||e.text,p=w(e.parentNode);if(f){if(p!="style"){f=d(f)}E.push(f)}}}function F(e,n,t,r){var i=e.childNodes;for(var a=0;a<i.length;a++){D(i[a],n,t,r)}}function K(n,t){var r;var i=sap.ui.getCore().getLoadedLibraries();e.each(i,function(e,i){if(n===i.namespace||n===i.name){r=i.name+"."+(i.tagNames&&i.tagNames[t]||t)}});r=r||n+"."+t;function a(e){if(!e){l.error("Control '"+r+"' did not return a class definition from sap.ui.define.","","XMLTemplateProcessor");e=f.get(r)}if(!e){l.error("Can't find object class '"+r+"' for XML-view","","XMLTemplateProcessor")}return e}var o=r.replace(/\./g,"/");var s=sap.ui.require(o);if(!s){if(m){return new Promise(function(e,n){sap.ui.require([o],function(n){n=a(n);e(n)},n)})}else{s=sap.ui.requireSync(o);s=a(s)}}return s}function H(e,n){if(e.namespaceURI===y||e.namespaceURI===b){var t=e.attributes["id"]?e.attributes["id"].textContent||e.attributes["id"].text:null;if(g){return V.enrichTemplateIdsPromise(e,c,m).then(function(){return[]})}else{var r=function(n){var r={id:t?$(c,e,t):undefined,xmlNode:e,containingView:c._oContainingView,processingMode:c._sProcessingMode};if(c.fnScopedRunWithOwner){return c.fnScopedRunWithOwner(function(){return new n(r)})}return new n(r)};if(m){return new Promise(function(e,n){sap.ui.require(["sap/ui/core/mvc/XMLView"],function(n){e([r(n)])},n)})}else{var i=sap.ui.requireSync("sap/ui/core/mvc/XMLView");return u.resolve([r(i)])}}}else{return z(e,n)}}function z(e,n){if(w(e)==="ExtensionPoint"&&e.namespaceURI===_){if(g){return u.resolve([])}else{var t=c instanceof i?c._oContainingView:c;var r=o._factory.bind(null,t,e.getAttribute("name"),function(){var t=u.resolve();var r=[];var i=e.childNodes;for(var a=0;a<i.length;a++){var o=i[a];if(o.nodeType===1){t=t.then(H.bind(null,o,n));r.push(t)}}return u.all(r).then(function(e){var n=[];e.forEach(function(e){n=n.concat(e)});return n})});return u.resolve(c.fnScopedRunWithOwner?c.fnScopedRunWithOwner(r):r())}}else{var a=K(e.namespaceURI,w(e));if(a&&typeof a.then==="function"){return a.then(function(t){return J(e,t,n)})}else{return J(e,a,n)}}}function J(e,n,o){var f=e.namespaceURI,d={},y={},b="",E=[],T=null,L=null;if(!n){return u.resolve([])}var O=n.getMetadata();var j=O.getAllSettings();var U=R(e,m);if(U){o=u.all([o,U]).then(function(e){return Object.assign({},e[0],e[1])})}o=o.then(function(o){if(v(o)){o=null}if(!g){for(var s=0;s<e.attributes.length;s++){var u=e.attributes[s],f=u.name,m,y=j[f],I=u.value;if(f==="id"){d[f]=$(c,e,I)}else if(f==="class"){b+=I}else if(f==="viewName"){d[f]=I}else if(f==="fragmentName"){d[f]=I;d["containingView"]=c._oContainingView}else if(f==="binding"&&!y||f==="objectBindings"){var M=t.bindingParser(I,c._oContainingView.oController);if(M){d.objectBindings=d.objectBindings||{};d.objectBindings[M.model||undefined]=M}}else if(f==="metadataContexts"){var A=null;try{A=V._calculatedModelMapping(I,c._oContainingView.oController,true)}catch(e){l.error(c+":"+e.message)}if(A){d.metadataContexts=A;if(V._preprocessMetadataContexts){V._preprocessMetadataContexts(n.getMetadata().getName(),d,c._oContainingView.oController)}}}else if(f.indexOf(":")>-1){m=u.namespaceURI;if(m===C){var R=w(u);E.push(new r({key:R,value:h("any",I,R,c._oContainingView.oController)}))}else if(m===x){L=I}else if(m&&m.startsWith(P)){l.debug(c+": XMLView parser ignored preprocessor attribute '"+f+"' (value: '"+I+"')")}else if(m===_||m===N||f.startsWith("xmlns:")){}else{if(!T){T={}}if(!T.hasOwnProperty(u.namespaceURI)){T[u.namespaceURI]={}}T[u.namespaceURI][w(u)]=u.nodeValue;l.debug(c+": XMLView parser encountered unknown attribute '"+f+"' (value: '"+I+"') with unknown namespace, stored as sap-ui-custom-settings of customData")}}else if(y&&y._iKind===0){d[f]=h(y.type,I,f,c._oContainingView.oController,o)}else if(y&&y._iKind===1&&y.altTypes){d[f]=h(y.altTypes[0],I,f,c._oContainingView.oController,o)}else if(y&&y._iKind===2){var M=t.bindingParser(I,c._oContainingView.oController,false,false,false,false,o);if(M){d[f]=M}else{l.error(c+": aggregations with cardinality 0..n only allow binding paths as attribute value (wrong value: "+f+"='"+I+"')")}}else if(y&&y._iKind===3){d[f]=W(I)}else if(y&&y._iKind===4){d[f]=I.split(/[\s,]+/g).filter(B).map(W)}else if(y&&y._iKind===5){var S=[];a.parse(I).forEach(function(e){var n=a.resolveEventHandler(e,c._oContainingView.oController,o);if(n){S.push(n)}else{l.warning(c+': event handler function "'+e+'" is not a function or does not exist in the controller.')}});if(S.length){d[f]=S}}else if(y&&y._iKind===-1){if(i.prototype.isPrototypeOf(n.prototype)&&f=="async"){d[f]=h(y.type,I,f,c._oContainingView.oController,o)}else{l.warning(c+": setting '"+f+"' for class "+O.getName()+" (value:'"+I+"') is not supported")}}else{p(f==="xmlns",c+": encountered unknown setting '"+f+"' for class "+O.getName()+" (value:'"+I+"')");if(V._supportInfo){V._supportInfo({context:e,env:{caller:"createRegularControls",error:true,info:"unknown setting '"+f+"' for class "+O.getName()}})}}}if(T){E.push(new r({key:"sap-ui-custom-settings",value:T}))}if(E.length>0){d.customData=E}}return o});var X=M(m,k);function k(e,n,t,r,i,a){var o,u;if(r.nodeType===1){if(r.namespaceURI===I){d[w(r)]=r.querySelector("*");return}o=r.namespaceURI===f&&t&&t[w(r)];if(o){return X(r,o,false,a)}else if(n){if(!i&&r.getAttribute("stashed")==="true"&&!g){u=function(){s.createStashedControl($(c,r),{sParentId:d["id"],sParentAggregationName:n.name,fnCreate:function(){var i=m;m=false;try{return k(e,n,t,r,true,a).unwrap()}finally{m=i}}})};if(c.fnScopedRunWithOwner){c.fnScopedRunWithOwner(u)}else{u()}return}return H(r,a).then(function(e){for(var t=0;t<e.length;t++){var r=e[t];var i=n.name;if(r._isExtensionPoint){if(!d[i]){d[i]=[]}var a=y[i];if(!a){a=y[i]=[]}r.index=d[i].length;r.aggregationName=i;var o=a[a.length-1];if(o){o._nextSibling=r}a.push(r)}else if(n.multiple){if(!d[i]){d[i]=[]}if(typeof d[i].path==="string"){p(!d[i].template,"list bindings support only a single template object");d[i].template=r}else{d[i].push(r)}}else{p(!d[i],"multiple aggregates defined for aggregation with cardinality 0..1");d[i]=r}}return e})}else if(w(e)!=="FragmentDefinition"||e.namespaceURI!==_){throw new Error("Cannot add direct child without default aggregation defined for control "+O.getElementName())}}else if(r.nodeType===3){var l=r.textContent||r.text;if(l&&l.trim()){throw new Error("Cannot add text nodes as direct child of an aggregation. For adding text to an aggregation, a surrounding html tag is needed: "+l.trim())}}}var D=O.getDefaultAggregation();var F=O.getAllAggregations();return X(e,D,F,o).then(function(){var t;var r=u.resolve();if(g&&e.hasAttribute("id")){Z(c,e)}else if(!g){if(i.prototype.isPrototypeOf(n.prototype)&&typeof n._sType==="string"){var a=function(){if(n.getMetadata().isA("sap.ui.core.mvc.XMLView")&&c._sProcessingMode==="sequential"){d.processingMode="sequential"}return i._legacyCreate(d,undefined,n._sType)};if(c.fnScopedRunWithOwner){t=c.fnScopedRunWithOwner(a)}else{t=a()}}else{var o=function(){var t;if(n.getMetadata().isA("sap.ui.core.Fragment")&&e.getAttribute("type")!=="JS"&&c._sProcessingMode==="sequential"){d.processingMode="sequential"}if(c.fnScopedRunWithOwner){t=c.fnScopedRunWithOwner(function(){var e=new n(d);return e})}else{t=new n(d)}r=S(m,t,y);return t};if(A&&A.fnRunWithPreprocessor){t=A.fnRunWithPreprocessor(o)}else{t=o()}}if(b&&t.addStyleClass){t.addStyleClass(b)}}if(!t){t=[]}else if(!Array.isArray(t)){t=[t]}if(V._supportInfo&&t){for(var s=0,l=t.length;s<l;s++){var f=t[s];if(f&&f.getId()){var p=V._supportInfo({context:e,env:{caller:"createRegularControls",nodeid:e.getAttribute("id"),controlid:f.getId()}}),v=L?L+",":"";v+=p;V._supportInfo.addSupportInfo(f.getId(),v)}}}if(q){t.forEach(function(n){if(O.getCompositeAggregationName){var t=e.getElementsByTagName(n.getMetadata().getCompositeAggregationName());for(var r=0;r<t.length;r++){e.removeChild(t[0])}}n._sapui_declarativeSourceInfo={xmlNode:e,xmlRootNode:c._sapui_declarativeSourceInfo.xmlRootNode,fragmentName:O.getName()==="sap.ui.core.Fragment"?d["fragmentName"]:null}})}return r.then(function(){return t})})}function $(e,n,t){if(n.getAttributeNS(N,"id")){return n.getAttribute("id")}else{return W(t?t:n.getAttribute("id"))}}function Z(e,n){n.setAttribute("id",W(n.getAttribute("id")));n.setAttributeNS(N,"id",true)}}V._preprocessMetadataContexts=null;V._calculatedModelMapping=function(e,n,r){var i,a={},o=t.bindingParser(e,n);function s(e){if(e.length%2===0){throw new Error("The last entry is no binding")}for(var n=1;n<=e.length;n=n+2){if(typeof e[n-1]=="string"){throw new Error("Binding expected not a string")}if(e[n]){if(typeof e[n]!="string"||e[n]!=","){throw new Error("Missing delimiter ','")}}}}if(o){if(!o.formatter){i=o;o={parts:[i]}}else{s(o.formatter.textFragments)}for(var u=0;u<o.parts.length;u++){i=o.parts[u];a[i.model]=a[i.model]||(r?[]:null);if(Array.isArray(a[i.model])){a[i.model].push(i)}else{a[i.model]=i}}}return a};return V},true);