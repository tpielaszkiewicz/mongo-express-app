/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_ODataMetaModelUtils","sap/base/assert","sap/base/Log","sap/base/util/each","sap/base/util/uid","sap/ui/base/EventProvider","sap/ui/core/cache/CacheManager","sap/ui/thirdparty/datajs","sap/ui/thirdparty/jquery"],function(t,e,n,a,i,s,r,o,p){"use strict";var f="sap.ui.model.odata.ODataMetadata";var h=s.extend("sap.ui.model.odata.ODataMetadata",{constructor:function(t,e){s.apply(this,arguments);this.bLoaded=false;this.bFailed=false;this.mEntityTypes={};this.mRequestHandles={};this.sUrl=t;this.bAsync=e.async;this.sUser=e.user;this.bWithCredentials=e.withCredentials;this.sPassword=e.password;this.mHeaders=e.headers;this.sCacheKey=e.cacheKey;this.oLoadEvent=null;this.oFailedEvent=null;this.oMetadata=null;this.bMessageScopeSupported=false;this.mNamespaces=e.namespaces||{sap:"http://www.sap.com/Protocols/SAPData",m:"http://schemas.microsoft.com/ado/2007/08/dataservices/metadata","":"http://schemas.microsoft.com/ado/2007/06/edmx"};var a=this;this.pLoadedWithReject=new Promise(function(t,e){a.fnResolve=t;a.fnReject=e});this.pLoaded=this.pLoadedWithReject.catch(function(t){return new Promise(function(t,e){a.fnResolve=t})});function i(t){r.set(a.sCacheKey,JSON.stringify({metadata:a.oMetadata,params:t}))}function o(t){n.error("[ODataMetadata] initial loading of metadata failed");if(t&&t.message){n.error("Error: "+t.message)}}if(this.sCacheKey){r.get(this.sCacheKey).then(function(t){if(t){var e=JSON.parse(t);this.oMetadata=e.metadata;this._handleLoaded(this.oMetadata,e.params,false)}else{this._loadMetadata().then(i).catch(o)}}.bind(this)).catch(o)}else{this._loadMetadata().catch(o)}},metadata:{publicMethods:["getServiceMetadata","attachFailed","detachFailed","attachLoaded","detachLoaded","refresh"]}});h.prototype._setNamespaces=function(t){this.mNamespaces=t};h.prototype._handleLoaded=function(t,e,n){var a=[];this.oMetadata=this.oMetadata?this.merge(this.oMetadata,t,a):t;this.oRequestHandle=null;e.entitySets=a;this.fnResolve(e);if(this.bAsync&&!n){this.fireLoaded(this)}else if(!this.bAsync&&!n){this.bLoaded=true;this.bFailed=false;this.oLoadEvent=setTimeout(this.fireLoaded.bind(this,e),0)}};h.prototype._loadMetadata=function(t,e){var n=this;t=t||this.sUrl;var a=this._createRequest(t);return new Promise(function(t,s){var r;function p(i,s){if(!i||!i.dataServices){var r={message:"Invalid metadata document",request:a,response:s};f(r);return}n.sMetadataBody=s.body;n.oRequestHandle=null;var o={metadataString:n.sMetadataBody};var p=s.headers["Last-Modified"];if(p){o.lastModified=p}var h=s.headers["eTag"];if(h){o.eTag=h}n._handleLoaded(i,o,e);t(o)}function f(t){var a={message:t.message,request:t.request,response:t.response};if(t.response){a.statusCode=t.response.statusCode;a.statusText=t.response.statusText;a.responseText=t.response.body}if(r&&r.bSuppressErrorHandlerCall){return}if(n.bAsync){delete n.mRequestHandles[r.id]}s(a);n.fnReject(a);if(n.bAsync&&!e){n.fireFailed(a)}else if(!n.bAsync&&!e){n.bFailed=true;n.oFailedEvent=setTimeout(n.fireFailed.bind(n,a),0)}}r=o.request(a,p,f,o.metadataHandler);if(n.bAsync){r.id=i();n.mRequestHandles[r.id]=r}})};h.prototype.refresh=function(){return this._loadMetadata()};h.prototype.getServiceMetadata=function(){return this.oMetadata};h.prototype.isLoaded=function(){return this.bLoaded};h.prototype.loaded=function(t){return t?this.pLoadedWithReject:this.pLoaded};h.prototype.isFailed=function(){return this.bFailed};h.prototype.fireLoaded=function(t){this.bLoaded=true;this.bFailed=false;this.fireEvent("loaded",t);n.debug(this+" - loaded was fired");return this};h.prototype.attachLoaded=function(t,e,n){this.attachEvent("loaded",t,e,n);return this};h.prototype.detachLoaded=function(t,e){this.detachEvent("loaded",t,e);return this};h.prototype.fireFailed=function(t){this.bFailed=true;this.fireEvent("failed",t);return this};h.prototype.attachFailed=function(t,e,n){this.attachEvent("failed",t,e,n);return this};h.prototype.detachFailed=function(t,e){this.detachEvent("failed",t,e);return this};h.prototype._getEntityAssociationEnd=function(e,n){var a;if(!this._checkMetadataLoaded()){return null}this._mGetEntityAssociationEndCache=this._mGetEntityAssociationEndCache||{};a=e.namespace+"."+e.name+"/"+n;if(this._mGetEntityAssociationEndCache[a]===undefined){var i=e?t.findObject(e.navigationProperty,n):null,s=i?t.getObject(this.oMetadata.dataServices.schema,"association",i.relationship):null,r=s?t.findObject(s.end,i.toRole,"role"):null;this._mGetEntityAssociationEndCache[a]=r}return this._mGetEntityAssociationEndCache[a]};function y(t){var e={};for(var n=0;n<t.length;n++){var a=t[n];if(a.entityContainer){for(var i=0;i<a.entityContainer.length;i++){var s=a.entityContainer[i];if(s.entitySet){for(var r=0;r<s.entitySet.length;r++){if(s.entitySet[r].name!=null){e[s.entitySet[r].name]=s.entitySet[r]}}}}}}return e}h.prototype._findEntitySetByName=function(t){if(!this.mEntitySets){this.mEntitySets=y(this.oMetadata.dataServices.schema)}return this.mEntitySets[t]};h.prototype._getEntityTypeByPath=function(t){if(!t){e(undefined,"sPath not defined!");return null}if(this.mEntityTypes[t]){return this.mEntityTypes[t]}if(!this._checkMetadataLoaded()){return null}var n=t.replace(/^\/|\/$/g,""),a=n.split("/"),i=a.length,s,r,o,p,f=this;if(a[0].indexOf("(")!=-1){a[0]=a[0].substring(0,a[0].indexOf("("))}if(i>1){s=f._getEntityTypeByPath(a[0]);for(var h=1;h<a.length;h++){if(s){if(a[h].indexOf("(")!=-1){a[h]=a[h].substring(0,a[h].indexOf("("))}p=f._getEntityTypeByNavProperty(s,a[h]);if(p){s=p}o=s}}}else{r=this._splitName(this._getEntityTypeName(a[0]));o=this._getObjectMetadata("entityType",r.name,r.namespace);if(o){o.entityType=this._getEntityTypeName(a[0])}}if(!o){var y=a[a.length-1];var c=this._getFunctionImportMetadata(y,"GET");if(!c){c=this._getFunctionImportMetadata(y,"POST")}if(c&&c.entitySet){o=Object.assign({},this._getEntityTypeByPath(c.entitySet));if(o){o.entityType=this._getEntityTypeName(c.entitySet);o.isFunction=true}}}if(o){this.mEntityTypes[t]=o}return o};h.prototype._getEntityTypeByName=function(t){var n,a=this,i,s,r;if(!t){e(undefined,"sName not defined!");return null}r=this._splitName(t);s=r.namespace;i=r.name;if(!this._checkMetadataLoaded()){return null}if(this.mEntityTypes[t]){n=this.mEntityTypes[t]}else{p.each(this.oMetadata.dataServices.schema,function(e,r){if(r.entityType&&(!s||r.namespace===s)){p.each(r.entityType,function(e,s){if(s.name===i){n=s;a.mEntityTypes[t]=n;n.namespace=r.namespace;return false}})}})}return n};h.prototype._checkMetadataLoaded=function(){if(!this.oMetadata||p.isEmptyObject(this.oMetadata)){e(undefined,"No metadata loaded!");return false}return true};h.prototype._getAnnotation=function(t){var n,a,i,s,r,o,p;a=t.split("/#");s=a[1].split("/");if(!a[0]){r=this._getEntityTypeByName(s[0]);e(r,s[0]+" is not a valid EntityType");if(!r){return}o=a[1].substr(a[1].indexOf("/")+1);p=this._getPropertyMetadata(r,o);e(p,o+" is not a valid property path");if(!p){return}i=o.substr(o.indexOf(p.name));i=i.substr(i.indexOf("/")+1)}else{r=this._getEntityTypeByPath(a[0]);e(r,a[0]+" is not a valid path");if(!r){return}t=a[0].replace(/^\/|\/$/g,"");o=t;while(!p&&o.indexOf("/")>0){o=o.substr(o.indexOf("/")+1);p=this._getPropertyMetadata(r,o)}e(p,o+" is not a valid property path");if(!p){return}i=s.join("/")}n=this._getAnnotationObject(r,p,i);return n};h.prototype._getAnnotationObject=function(t,e,n){var a,i,s,r,o;if(!e){return}r=e;i=n.split("/");if(i[0].indexOf(".")>-1){return this._getV4AnnotationObject(t,e,i)}else{if(i.length>1){r=r[i[0]];if(!r&&e.extensions){for(var p=0;p<e.extensions.length;p++){var f=e.extensions[p];if(f.name==i[0]){r=f;break}}}n=i.splice(0,1);s=this._getAnnotationObject(t,r,i.join("/"))}else{if(i[0].indexOf("@")>-1){o=i[0].substr(1);a=o.split(":");s=r[a[0]];if(!s&&r.extensions){for(var p=0;p<r.extensions.length;p++){var f=r.extensions[p];if(f.name===a[1]&&f.namespace===this.mNamespaces[a[0]]){s=f.value;break}}}}else{a=i[0].split(":");s=r[a[0]];s=r[i[0]];if(!s&&r.extensions){for(var p=0;p<r.extensions.length;p++){var f=r.extensions[p];if(f.name===a[1]&&f.namespace===this.mNamespaces[a[0]]){s=f;break}}}}}}return s};h.prototype._getV4AnnotationObject=function(t,n,a){var i,s=[];if(a.length>1){e(a.length==1,"'"+a.join("/")+"' is not a valid annotation path");return}var r=t.namespace?t.namespace+".":"";r+=t.name+"/"+n.name;p.each(this.oMetadata.dataServices.schema,function(t,e){if(e.annotations){p.each(e.annotations,function(t,e){if(e.target===r&&!e.qualifier){s.push(e.annotation);return false}})}});if(s){p.each(s,function(t,e){p.each(e,function(t,e){if(e.term===a[0]){i=e}})})}return i};h.prototype._splitName=function(t){var e={};if(t){var n=t.lastIndexOf(".");e.name=t.substr(n+1);e.namespace=t.substr(0,n)}return e};h.prototype._getEntityTypeName=function(t){var e,n;if(t){n=this._findEntitySetByName(t);if(n){e=n.entityType}}return e};h.prototype._getObjectMetadata=function(t,e,n){var a;if(e&&n){p.each(this.oMetadata.dataServices.schema,function(i,s){if(s[t]&&s.namespace===n){p.each(s[t],function(t,n){if(n.name===e){a=n;a.namespace=s.namespace;return false}});return!a}})}return a};h.prototype.getUseBatch=function(){var t=false;p.each(this.oMetadata.dataServices.schema,function(e,n){if(n.entityContainer){p.each(n.entityContainer,function(e,n){if(n.extensions){p.each(n.extensions,function(e,n){if(n.name==="use-batch"&&n.namespace==="http://www.sap.com/Protocols/SAPData"){t=typeof n.value==="string"?n.value.toLowerCase()==="true":!!n.value;return false}})}})}});return t};h.prototype._getFunctionImportMetadataIterate=function(t,e){var n=[];a(this.oMetadata.dataServices.schema,function(i,s){if(s["entityContainer"]){a(s["entityContainer"],function(i,s){if(s["functionImport"]){a(s["functionImport"],function(a,i){if(t(i)){n.push(i);if(e){return false}}})}return!(e&&n.length===1)})}return!(e&&n.length===1)});return n};h.prototype._getFirstMatchingFunctionImportMetadata=function(t){var e=this._getFunctionImportMetadataIterate(t,true);return e.length===1?e[0]:null};h.prototype._getFunctionImportMetadataByName=function(t){if(t.indexOf("/")>-1){t=t.substr(t.indexOf("/")+1)}return this._getFunctionImportMetadataIterate(function(e){return e.name===t})};h.prototype._getFunctionImportMetadata=function(t,e){if(t.indexOf("/")>-1){t=t.substr(t.indexOf("/")+1)}return this._getFirstMatchingFunctionImportMetadata(function(n){return n.name===t&&n.httpMethod===e})};h.prototype._getEntityTypeByNavProperty=function(t,e){if(!t.navigationProperty){return undefined}for(var n=0;n<t.navigationProperty.length;++n){var a=t.navigationProperty[n];if(a.name===e){return this._getEntityTypeByNavPropertyObject(a)}}return undefined};h.prototype._getEntityTypeByNavPropertyObject=function(t){var e;var n=this._splitName(t.relationship);var a=this._getObjectMetadata("association",n.name,n.namespace);if(a){var i=a.end[0];if(i.role!==t.toRole){i=a.end[1]}var s=this._splitName(i.type);e=this._getObjectMetadata("entityType",s.name,s.namespace);if(e){e.entityType=i.type}}return e};h.prototype._getNavigationPropertyNames=function(t){var e=[];if(t.navigationProperty){p.each(t.navigationProperty,function(t,n){e.push(n.name)})}return e};h.prototype._getNavPropertyRefInfo=function(t,e){var n,i,s,r,o,p,f,h,y,c,u,d=this;a(t.navigationProperty,function(a,l){s=d._splitName(l.relationship);i=d._getObjectMetadata("association",s.name,s.namespace);if(!i||!i.referentialConstraint){return}p=i.referentialConstraint.dependent;y=i.end.find(function(t){return t.role===p.role});if(y.type!==t.namespace+"."+t.name){return}f=p.propertyRef.some(function(t){return t.name===e});if(!f){return}o=i.referentialConstraint.principal;h=o.role;r=d._getAssociationSetByAssociation(l.relationship);y=r.end.find(function(t){return t.role===h});c=y.entitySet;u=o.propertyRef.map(function(t){return t.name});n={name:l.name,entitySet:c,keys:u}});return n};h.prototype._getPropertyMetadata=function(t,e){var n,a=this;if(!t){return}e=e.replace(/^\/|\/$/g,"");var i=e.split("/");p.each(t.property,function(t,e){if(e.name===i[0]){n=e;return false}});if(i.length>1){if(!n){while(t&&i.length>1){t=this._getEntityTypeByNavProperty(t,i[0]);i.shift()}if(t){n=a._getPropertyMetadata(t,i[0])}}else if(!n.type.toLowerCase().startsWith("edm.")){var s=this._splitName(n.type);n=this._getPropertyMetadata(this._getObjectMetadata("complexType",s.name,s.namespace),i[1])}}return n};h.prototype.destroy=function(){delete this.oMetadata;var t=this;p.each(this.mRequestHandles,function(e,n){n.bSuppressErrorHandlerCall=true;n.abort();delete t.mRequestHandles[e]});if(!!this.oLoadEvent){clearTimeout(this.oLoadEvent)}if(!!this.oFailedEvent){clearTimeout(this.oFailedEvent)}s.prototype.destroy.apply(this,arguments)};h.prototype._fillElementCaches=function(){var t=this;if(this._entitySetMap||!this._checkMetadataLoaded()){return}this._entitySetMap={};this.oMetadata.dataServices.schema.forEach(function(e){(e.entityContainer||[]).forEach(function(e){(e.entitySet||[]).forEach(function(e){var n=t._getEntityTypeByName(e.entityType);n.__navigationPropertiesMap={};(n.navigationProperty||[]).forEach(function(t){n.__navigationPropertiesMap[t.name]=t});e.__entityType=n;t._entitySetMap[e.entityType]=e})})})};h.prototype._createRequest=function(t){var e={"sap-cancel-on-close":true},n={"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()};p.extend(e,this.mHeaders,n);var a={headers:e,requestUri:t,method:"GET",user:this.sUser,password:this.sPassword,async:this.bAsync};if(this.bAsync){a.withCredentials=this.bWithCredentials}return a};h.prototype._getEntitySetByPath=function(t){var e;this._fillElementCaches();e=this._getEntityTypeByPath(t);if(e){return this._entitySetMap[e.entityType]}};h.prototype._addUrl=function(t){var e=[].concat(t);return Promise.all(e.map(function(t){return this._loadMetadata(t,true)},this))};h.prototype.merge=function(t,e,n){var a=this;if(this.mEntitySets){delete this.mEntitySets}p.each(t.dataServices.schema,function(t,i){p.each(e.dataServices.schema,function(t,e){if(e.namespace===i.namespace){if(e.entityType){if(!a.mEntityTypeNames){a.mEntityTypeNames={};i.entityType.map(function(t){a.mEntityTypeNames[t.name]=true})}i.entityType=!i.entityType?[]:i.entityType;for(var s=0;s<e.entityType.length;s++){if(!(e.entityType[s].name in a.mEntityTypeNames)){i.entityType.push(e.entityType[s]);a.mEntityTypeNames[e.entityType[s].name]=true}}}if(i.entityContainer&&e.entityContainer){p.each(i.entityContainer,function(t,i){p.each(e.entityContainer,function(t,e){if(e.entitySet){if(e.name===i.name){if(!a.mEntitySetNames){a.mEntitySetNames={};i.entitySet.map(function(t){a.mEntitySetNames[t.name]=true})}i.entitySet=!i.entitySet?[]:i.entitySet;for(var s=0;s<e.entitySet.length;s++){if(!(e.entitySet[s].name in a.mEntitySetNames)){i.entitySet.push(e.entitySet[s]);a.mEntitySetNames[e.entitySet[s].name]=true}}e.entitySet.forEach(function(t){n.push(t)})}}})})}if(e.annotations){i.annotations=!i.annotations?[]:i.annotations;i.annotations=i.annotations.concat(e.annotations)}}})});return t};h.prototype._getEntitySetByType=function(t){var e=t.namespace+"."+t.name;var n=this.oMetadata.dataServices.schema;for(var a=0;a<n.length;++a){var i=n[a].entityContainer;if(i){for(var s=0;s<i.length;++s){var r=i[s].entitySet;if(r){for(var o=0;o<r.length;++o){if(r[o].entityType===e){return r[o]}}}}}}return null};h.prototype._calculateCanonicalPath=function(t){var e,n,a,i;if(t){n=t.lastIndexOf(")");if(n!==-1){i=t.substr(0,n+1);var s=this._getEntitySetByPath(i);if(s){if(s.__entityType.isFunction){e=t}else{a=t.split("/");if(i==="/"+a[1]){if(!(a[2]in s.__entityType.__navigationPropertiesMap)){e=t}}else{a=i.split("/");i="/"+s.name+a[a.length-1].substr(a[a.length-1].indexOf("("))+t.substr(n+1);if(i!==t){e=i}}}}}}return e};h.prototype._getAssociationSetByAssociation=function(t){var e=this.oMetadata.dataServices.schema;for(var n=0;n<e.length;++n){var a=e[n].entityContainer;if(a){for(var i=0;i<a.length;++i){var s=a[i].associationSet;if(s){for(var r=0;r<s.length;++r){if(s[r].association===t){return s[r]}}}}}}return null};h.prototype._isMessageScopeSupported=function(){var t=this.oMetadata.dataServices.schema,e,n;if(!this.bMessageScopeSupported&&t){for(var a=0;a<t.length;++a){n=t[a].entityContainer;if(n){for(var i=0;i<n.length;++i){e=n[i];if(e.extensions&&Array.isArray(e.extensions)){for(var s=0;s<e.extensions.length;++s){if(e.extensions[s].name==="message-scope-supported"&&e.extensions[s].namespace===this.mNamespaces.sap){if(e.extensions[s].value==="true"){this.bMessageScopeSupported=true;break}}}}}}}}return this.bMessageScopeSupported};h.prototype._isCollection=function(t){var e=false;var n=t.lastIndexOf("/");if(n>0){var a=t.substring(0,n);var i=this._getEntityTypeByPath(a);if(i){var s=this._getEntityAssociationEnd(i,t.substring(n+1));if(s&&s.multiplicity==="*"){e=true}}}else{e=true}return e};h.prototype._getReducedPath=function(t){var e,n,a,i,s,r,o,p=t.split("/"),f;if(p.length<4){return t}this._fillElementCaches();for(n=1;n<p.length-2;n+=1){f=this._getEntityTypeByPath(p.slice(0,n+1).join("/"));s=f&&f.__navigationPropertiesMap[p[n+1].split("(")[0]];if(!s){continue}o=p[n+2].split("(")[0];i=this._getEntityTypeByNavPropertyObject(s);r=i&&i.__navigationPropertiesMap[o];if(!r||s.relationship!==r.relationship){continue}a=p[n+2].slice(o.length);e=this._getEntityAssociationEnd(i,o);if(e.multiplicity!=="*"||a&&p[n].endsWith(a)){p.splice(n+1,2);return this._getReducedPath(p.join("/"))}}return p.join("/")};h.prototype.getKeyPropertyNamesByPath=function(t){var e,n,a=t.lastIndexOf("/");if(a>0){n=this._getEntityTypeByPath(t.slice(0,a));if(n){e=this._getEntityAssociationEnd(n,t.slice(a+1).split("(")[0]);n=e?this._getEntityTypeByName(e.type):undefined}}else{n=this._getEntityTypeByPath(t)}if(n){return n.key.propertyRef.map(function(t){return t.name})}};h.prototype._getCanonicalPathOfFunctionImport=function(t,e){var a,i,s,r,o,p,h,y=t.extensions,c="";if(y){for(r=0;r<y.length;r+=1){if(y[r].name==="action-for"){a=y[r].value;break}}}if(a){s=this._getEntityTypeByName(a)}else if(t.entitySet){s=this._getEntityTypeByPath(t.entitySet)}else if(t.returnType){s=this._getEntityTypeByName(t.returnType)}if(s){i=this._getEntitySetByType(s);if(i&&s.key&&s.key.propertyRef){h=s.key.propertyRef;if(h.length===1){p=h[0].name;if(e[p]){c=e[p]}}else{o=[];for(r=0;r<h.length;r+=1){p=h[r].name;if(e[p]){o.push(p+"="+e[p])}}c=o.join(",")}return"/"+i.name+"("+c+")"}else if(!i){n.error("Cannot determine path of the EntitySet for the function import '"+t.name+"'",this,f)}else{n.error("Cannot determine keys of the EntityType '"+s.entityType+"' for the function import '"+t.name+"'",this,f)}}return""};return h});